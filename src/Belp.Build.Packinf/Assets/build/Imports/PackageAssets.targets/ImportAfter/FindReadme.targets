<Project InitialTargets="_CheckReadmePresence" ToolsVersion="15.0" xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- If PackageReadme is already defined, then disable further search. -->
  <Target Name="_CheckReadmePresence">
    <PropertyGroup Condition="@(PackageReadme->Count()) != 0">
      <PackageReadmeFound>true</PackageReadmeFound>
      <FindReadmeInPackageFiles>false</FindReadmeInPackageFiles>
    </PropertyGroup>
  </Target>



  <!-- Try find README in project or package assets folders. -->
  <Target Name="_TryFindReadme" Condition="'$(PackageReadmeFound)' != 'true'">
    <ItemGroup>
      <PackageReadme Include="@(None->WithMetadataValue('Pack', 'true')->WithMetadataValue('Filename', 'README'))" Condition="('%(None.PackagePath)' == '' And '%(RecursiveDir)' == '' And (!$([System.IO.Path]::IsPathRooted('%(RelativeDir)')) Or '$([MSBuild]::MakeRelative($(MSBuildProjectDirectory), %(RelativeDir)))' == '')) Or ('%(None.PackagePath)' != '' And '$([System.Text.RegularExpressions.Regex]::Replace($([System.IO.Path]::GetDirectoryName(%(None.PackagePath))), \A[/\\]+, ))' == '')">
        <ItemSource Condition="'%(PackageReadme.ItemSource)' != 'PackageAssets'">DefaultItems</ItemSource>
      </PackageReadme>
    </ItemGroup>
  </Target>



  <!-- Try looking for README in repository root -->
  <Target Name="_TryFindReadmeFromRepositoryRoot" BeforeTargets="_GetPackageFiles" Condition="'$(PackageReadmeFound)' != 'true' And @(PackageReadme->Count()) == 0" DependsOnTargets="InitializeSourceControlInformation">
    <ItemGroup>
      <PackageReadme Include="@(SourceRoot->Combine('README.md'))" Condition="'%(SourceRoot.SourceControl)' != '' And '%(SourceRoot.ContainingRoot)' == '' And Exists('%(FullPath)README.md')" Pack="true" PackagePath="\">
        <ItemSource>RepositoryRoot</ItemSource>
      </PackageReadme>
      <None Include="@(PackageReadme->WithMetadataValue('ItemSource', 'RepositoryRoot'))" Pack="true" PackagePath="/%(Filename)%(Extension)" />
    </ItemGroup>
  </Target>



  <!-- Raise diagnostics for invalid configurations. -->
  <Target Name="_DetectInvalidReadmeConfiguration">
    <Warning Code="PKF4006" Condition="@(PackageReadme->Count()) != 1" File="%(PackageReadme.Identity)" Text="Only one README is required." />
  </Target>

  <!-- Set README in package metadata. -->
  <Target Name="_SetReadmeIfExists" Condition="@(PackageReadme->Count()) != 0" DependsOnTargets="_DetectInvalidReadmeConfiguration">
    <PropertyGroup>
      <PackageReadmeFile Condition="'%(PackageReadme.PackagePath)' != ''">$([System.IO.Path]::GetFileName('%(PackageReadme.PackagePath)'))</PackageReadmeFile>
      <PackageReadmeFile Condition="'$(PackageReadmeFile)' == ''">%(PackageReadme.Filename)%(PackageReadme.Extension)</PackageReadmeFile>
    </PropertyGroup>
  </Target>

</Project>
